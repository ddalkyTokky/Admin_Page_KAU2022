pipeline {
    agent any
    
    environment {
        // EC2 Information
        ec2_ip = credentials('EC2_Jenkins_ip')
        ec2_private_key = 'EC2_Jenkins_private_key'

        // Github User Information
        user_info = credentials('github_user_info')

        // Github Repository Information
        github_info = credentials('CI-CD-Test-github-repo')
    }
    stages{
        stage('Git Clone'){
            steps{
                gitClone(ec2_ip)
            }
        }
        stage('install PM2'){
            steps{
                installPM2(ec2_ip)
            }
        }
        stage('Start Service'){
            steps{
                startService(ec2_ip)
            }
        }
    }
}

def gitClone(ip){
    sshagent(credentials: [ec2_private_key]) {
        sh """
        ssh -o StrictHostKeyChecking=no ubuntu@${ip} '
        sudo apt update
        sudo apt-get install git
        sudo rm -r .${github_info_psw}
        sudo git clone https://${user_info_usr}:${user_info_psw}@github.com${github_info_usr}${github_info_psw}.git 
        '
        """
    }
}

def installPM2(ip){
    sshagent(credentials: [ec2_private_key]) {
        sh """
        ssh -o StrictHostKeyChecking=no ubuntu@${ip} '
        sudo apt update
        sudo apt-get install nodejs
        sudo apt-get install npm
        sudo npm install -g pm2@latest
        '
        """
    }
}

def startService(ip){
    sshagent(credentials: [ec2_private_key]) {
        sh """
        ssh -o StrictHostKeyChecking=no ubuntu@${ip} '
        cd .${github_info_psw}
        sudo pm2 kill
        sudo pm2 start server.js
        '
        """
    }
}